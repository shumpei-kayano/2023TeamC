<!-- カウンセリング実行画面（日次グラフ） -->
{% extends "base_diary.html" %}

{% load static %}

{% block title %}グラフ{% endblock %}

{% block header %}
<header>
    <div class="header__spacer--top"></div>
    <h1 class="date">--/--(-)</h1>
    <div class="header__weather">
        <img class="weatherImg">
        <span class="tempMax">-℃</span>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- タブ -->
{% url 'diary:today_counseling' as today_counseling_url %}
{% url 'diary:today_counseling_graph' as today_counseling_graph_url %}
<div class="tab__button a--tab">
    <div class="a--tab--left {% if request.path == today_counseling_url %}active{% endif %}">
        <a href="{{ today_counseling_url }}">日記詳細画面</a>
    </div>
    <div class="a--tab--right {% if request.path == today_counseling_graph_url %}active{% endif %}">
        <a href="{{ today_counseling_graph_url }}">グラフ</a>
    </div>
</div>

<!-- グラフの表示 -->
<script src="{% static 'js/chart.min.js' %}"></script>

<div id="circle__graph">
    <div class="circle__graph__img">
        <img src="{% static 'diary/assets/circle_graph.png' %}" alt="感情グラフ">感情の合計</img>
        {% comment %} グラフを表示 {% endcomment %}
        <div style="position: relative;">
            <canvas id="myPieChart" width="400" height="200"></canvas>
            <div id="popup" style="position: absolute; display: none; background-color: rgba(255, 255, 255, 0.7); border: 1px solid #000; padding: 10px;"></div>
        </div>
    </div>
</div>

<!-- ネココのカウンセリングコメント -->
<div class="content__today-diary__counseling-comment">
    <p>
        {{ カウンセリングのコメントを表示させてください }}
    </p>
</div>
<!-- ネコココメントの画像 -->
<div class="content__today-diary__comment__img">
    <img src="{% static'diary/assets/counselor_neko.png' %}" alt="カウンセラーネココの画像">
</div>
</form>

{% endblock %}

{% block javascripts %}
<script>
var data = {{ data|safe }};
var canvas = document.getElementById('myPieChart');

var ctx = canvas.getContext('2d');
var myPieChart = new Chart(ctx, {
    type: 'pie',
    data: {
        labels: data.labels,
        datasets: [{
            data: data.values,
            backgroundColor: ['red', 'blue', 'green', 'yellow']  // カラーコードを指定
        }]
    }
});

// 円グラフのクリックイベント処理
canvas.onclick = function(evt) {
    var activePoint = myPieChart.getElementsAtEvent(evt)[0];
    if (activePoint) {
        // クリックした項目に関連付けられた詳細情報を取得
        var itemIndex = activePoint._index;
        var itemLabel = data.labels[itemIndex];
        var itemValue = data.values[itemIndex];

        // クリック位置に詳細情報を表示
        var popup = document.getElementById('popup');
        popup.style.display = 'block';
        popup.style.left = (evt.clientX - canvas.getBoundingClientRect().left) + 'px';
        popup.style.top = (evt.clientY - canvas.getBoundingClientRect().top) + 'px';
        popup.innerHTML = `<p>項目: ${itemLabel}</p><p>値: ${itemValue}</p>`;

        // クリックした項目の詳細情報を非表示にするために、別の場所をクリックした際にポップアップを非表示にするコードを追加
        document.body.onclick = function() {
            popup.style.display = 'none';
        };
    }
};

</script>
{% endblock %}